<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - DieBuddy</title>

    <!-- External CSS Files -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/fonts.css">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/images/logo/favicon.png">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">DieBuddy</div>
            <div class="nav-links">
                <a href="../index.html">Home</a>
                <a href="features.html">Features</a>
                <a href="contact.html">Contact</a>
                <a href="privacy.html">Privacy Policy</a>
            </div>
        </div>
    </nav>

    <!-- Password Reset Content -->
    <div class="page active" style="padding-top: 120px;">
        <div class="container">
            <div class="verification-container">
                <div class="verification-icon" id="headerIcon" style="font-size: 5rem; color: #b22222; margin-bottom: 2rem;">üîí</div>
                <h1 id="headerTitle" style="color: #b22222; margin-bottom: 1rem;">Reset Your Password</h1>
                <p id="headerDescription" style="font-size: 1.3rem; margin-bottom: 3rem; color: #666;">Enter your new password below to secure your DieBuddy account.</p>

                <!-- Password Reset Form -->
                <div class="verification-form" id="resetFormContainer">
                    <form id="resetPasswordForm" style="max-width: 500px; margin: 0 auto;">
                        <div style="margin-bottom: 1.5rem;">
                            <label for="newPassword" style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: bold;">New Password</label>
                            <input
                                type="password"
                                id="newPassword"
                                placeholder="Enter your new password"
                                required
                                minlength="8"
                                style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; transition: border-color 0.3s ease;">
                            <div id="passwordRequirements" style="margin-top: 0.75rem; font-size: 0.9rem;">
                                <div style="color: #666; font-weight: bold; margin-bottom: 0.5rem;">Password must contain:</div>
                                <div id="req-length" style="color: #999; margin-bottom: 0.25rem;">‚úó At least 8 characters</div>
                                <div id="req-letter" style="color: #999; margin-bottom: 0.25rem;">‚úó At least 1 letter</div>
                                <div id="req-number" style="color: #999; margin-bottom: 0.25rem;">‚úó At least 1 number</div>
                                <div id="req-special" style="color: #999; margin-bottom: 0.25rem;">‚úó At least 1 special character (!@#$%^&*)</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 2rem;">
                            <label for="confirmPassword" style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: bold;">Confirm Password</label>
                            <input
                                type="password"
                                id="confirmPassword"
                                placeholder="Confirm your new password"
                                required
                                minlength="8"
                                style="width: 100%; padding: 1rem; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; transition: border-color 0.3s ease;">
                        </div>

                        <!-- Status Message -->
                        <div id="statusMessage" style="display: none; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: center;"></div>

                        <!-- Submit Button -->
                        <button
                            type="submit"
                            id="submitButton"
                            disabled
                            style="width: 100%; background: linear-gradient(45deg, #b22222, #dc143c); color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: not-allowed; box-shadow: 0 5px 15px rgba(178, 34, 34, 0.3); transition: all 0.3s ease; opacity: 0.5;">
                            Reset Password
                        </button>
                        <small id="buttonHint" style="display: block; text-align: center; margin-top: 0.5rem; color: #999;">Complete all requirements to enable button</small>
                    </form>
                </div>

                <!-- Success View (Hidden Initially) -->
                <div id="successView" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 5rem; margin-bottom: 2rem; color: #4CAF50;">‚úÖ</div>
                    <h2 style="color: #4CAF50; margin-bottom: 1rem;">Password Reset Successfully!</h2>
                    <p style="margin-bottom: 2rem; color: #666; font-size: 1.1rem;">
                        Your password has been updated. You can now sign in to the DieBuddy app with your new password.
                    </p>

                    <!-- App Launch Buttons -->
                    <div style="margin: 2rem 0;">
                        <button onclick="openDieBuddyApp()" style="background: linear-gradient(45deg, #b22222, #dc143c); color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 0.5rem; box-shadow: 0 5px 15px rgba(178, 34, 34, 0.3); transition: transform 0.3s ease;">
                            üöÄ Open DieBuddy App
                        </button>
                    </div>

                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                        <button onclick="window.location.href='../index.html'" style="background: transparent; border: 2px solid #b22222; color: #b22222; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                            üè† Back to Home
                        </button>
                    </div>
                </div>

                <!-- Error View (Hidden Initially) -->
                <div id="errorView" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 5rem; margin-bottom: 2rem; color: #dc143c;">‚ö†Ô∏è</div>
                    <h2 style="color: #dc143c; margin-bottom: 1rem;">Reset Link Invalid or Expired</h2>
                    <p style="margin-bottom: 2rem; color: #666; font-size: 1.1rem;">
                        This password reset link is either invalid or has expired. Please request a new password reset from the app.
                    </p>

                    <div style="margin-top: 2rem;">
                        <button onclick="openDieBuddyApp()" style="background: linear-gradient(45deg, #b22222, #dc143c); color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 0.5rem; box-shadow: 0 5px 15px rgba(178, 34, 34, 0.3); transition: transform 0.3s ease;">
                            üöÄ Open DieBuddy App
                        </button>
                    </div>

                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                        <button onclick="window.location.href='contact.html'" style="background: transparent; border: 2px solid #6c757d; color: #6c757d; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                            üí¨ Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
            <div>
                <h4 style="color: #b22222; margin-bottom: 1rem;">DieBuddy</h4>
                <p>Track your games, improve your skills, have more fun!</p>
                <div style="margin-top: 1rem;">
                    <a href="https://gofund.me/655b9f14" target="_blank" style="color: #b22222; margin-right: 1rem;">üíñ Support Us</a>
                </div>
            </div>

            <div>
                <h4 style="color: #b22222; margin-bottom: 1rem;">Support</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="contact.html">üìß Contact Support</a>
                    <a href="contact.html">‚ùì Get Help</a>
                    <a href="privacy.html">üîí Privacy Policy</a>
                </div>
            </div>

            <div>
                <h4 style="color: #b22222; margin-bottom: 1rem;">Get Started</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="#" onclick="openDieBuddyApp()">üöÄ Open App</a>
                    <a href="features.html">‚≠ê View Features</a>
                    <a href="../index.html">üè† Homepage</a>
                </div>
            </div>
        </div>

        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 2rem; text-align: center;">
            <p>&copy; 2025 DieBuddy. All rights reserved.</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Secure password reset powered by Supabase</p>
        </div>
    </div>

    <!-- External JavaScript Files -->
    <script src="../assets/js/navigation.js"></script>
    <script src="../assets/js/supabase.js"></script>
    <script src="../assets/js/main.js"></script>

    <!-- Password Reset JavaScript -->
    <script>
        // =====================================
        // DIEBUDDY PASSWORD RESET PAGE
        // =====================================

        console.log('üîí DieBuddy password reset page loaded');

        // Supabase Configuration
        const SUPABASE_URL = 'https://YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

        // Initialize Supabase
        let supabaseWeb;
        try {
            if (typeof window !== 'undefined' && window.supabase) {
                supabaseWeb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase initialized successfully');
            }
        } catch (error) {
            console.error('‚ùå Failed to initialize Supabase:', error);
        }

        // =====================================
        // PASSWORD RESET FUNCTIONALITY
        // =====================================

        async function handlePasswordReset(event) {
            event.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = document.getElementById('submitButton');
            const statusMessage = document.getElementById('statusMessage');

            // Validate password requirements
            const validation = validatePassword(newPassword);
            if (!validation.valid) {
                showStatus(validation.message, 'error');
                return;
            }

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showStatus('Passwords do not match. Please try again.', 'error');
                return;
            }

            // Disable button and show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">üîÑ</span> Resetting Password...';

            try {
                // Update the user's password using Supabase
                const { data, error } = await supabaseWeb.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    throw error;
                }

                console.log('‚úÖ Password updated successfully:', data);

                // Sign out the user to ensure clean state
                // This forces them to sign in with the new password
                await supabaseWeb.auth.signOut();
                console.log('‚úÖ User signed out after password reset');

                // Hide form and show success view
                document.getElementById('resetFormContainer').style.display = 'none';
                document.getElementById('successView').style.display = 'block';

                // Update header
                document.getElementById('headerIcon').textContent = '‚úÖ';
                document.getElementById('headerIcon').style.color = '#4CAF50';
                document.getElementById('headerTitle').textContent = 'Password Reset Successfully!';
                document.getElementById('headerTitle').style.color = '#4CAF50';
                document.getElementById('headerDescription').textContent = 'You can now sign in with your new password.';

            } catch (error) {
                console.error('‚ùå Password reset error:', error);
                showStatus('Failed to reset password: ' + error.message, 'error');

                // Re-enable button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Reset Password';
            }
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.style.display = 'block';

            if (type === 'error') {
                statusMessage.style.background = '#fee';
                statusMessage.style.color = '#c00';
                statusMessage.style.border = '2px solid #c00';
                statusMessage.innerHTML = '‚ùå ' + message;
            } else if (type === 'success') {
                statusMessage.style.background = '#efe';
                statusMessage.style.color = '#0a0';
                statusMessage.style.border = '2px solid #0a0';
                statusMessage.innerHTML = '‚úÖ ' + message;
            } else {
                statusMessage.style.background = '#eef';
                statusMessage.style.color = '#00a';
                statusMessage.style.border = '2px solid #00a';
                statusMessage.innerHTML = '‚ÑπÔ∏è ' + message;
            }

            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        // =====================================
        // APP OPENING FUNCTIONS
        // =====================================

        function openDieBuddyApp() {
            // Try multiple methods to open the app
            const appSchemes = [
                'diebuddy://',
                'diebuddy://signin',
                'diebuddy://home',
            ];

            let attemptCount = 0;

            function tryOpenApp() {
                if (attemptCount < appSchemes.length) {
                    const scheme = appSchemes[attemptCount];
                    console.log(`Attempting to open app with scheme: ${scheme}`);

                    // Create a hidden iframe to trigger the app
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = scheme;
                    document.body.appendChild(iframe);

                    // Remove iframe after attempt
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 1000);

                    attemptCount++;

                    // Try next scheme if this one fails
                    setTimeout(() => {
                        if (attemptCount < appSchemes.length) {
                            tryOpenApp();
                        }
                    }, 2000);
                }
            }

            // Start the attempt
            tryOpenApp();

            // Also try the universal link approach
            setTimeout(() => {
                window.location.href = 'diebuddy://signin';
            }, 500);
        }

        // =====================================
        // TOKEN VERIFICATION
        // =====================================

        async function verifyResetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));

            const accessToken = urlParams.get('access_token') || hashParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
            const type = urlParams.get('type') || hashParams.get('type');

            console.log('Token verification:', { type, hasAccessToken: !!accessToken, hasRefreshToken: !!refreshToken });

            // If no tokens are present, allow form to work (for testing or when tokens are in session)
            if (!accessToken && !refreshToken) {
                console.log('‚ÑπÔ∏è No tokens in URL - checking for existing session or allowing test mode');

                // Check if there's already a valid session
                if (supabaseWeb) {
                    try {
                        const { data: { session } } = await supabaseWeb.auth.getSession();
                        if (session) {
                            console.log('‚úÖ Found existing session');
                            return true;
                        }
                    } catch (error) {
                        console.log('No existing session found');
                    }
                }

                // Allow form to show for testing (it will fail on submit without valid session)
                console.log('‚ö†Ô∏è No session found - form will show but may fail on submit');
                return true;
            }

            // If we have tokens, set up the session
            if (accessToken && refreshToken && supabaseWeb) {
                try {
                    const { data, error } = await supabaseWeb.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });

                    if (error) {
                        console.error('Session setup failed:', error);
                        showErrorView();
                        return false;
                    }

                    if (data.user) {
                        console.log('‚úÖ Valid reset session for user:', data.user.email);
                        // Clean up URL to remove tokens
                        window.history.replaceState({}, document.title, window.location.pathname);
                        return true;
                    }
                } catch (error) {
                    console.error('Session error:', error);
                    showErrorView();
                    return false;
                }
            }

            return true;
        }

        function showErrorView() {
            document.getElementById('resetFormContainer').style.display = 'none';
            document.getElementById('errorView').style.display = 'block';
            document.getElementById('headerIcon').style.display = 'none';
            document.getElementById('headerTitle').style.display = 'none';
            document.getElementById('headerDescription').style.display = 'none';
        }

        // =====================================
        // INPUT VALIDATION & UX ENHANCEMENTS
        // =====================================

        function validatePassword(password) {
            const hasMinLength = password.length >= 8;
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

            if (!hasMinLength) {
                return { valid: false, message: 'Password must be at least 8 characters long.' };
            }
            if (!hasLetter) {
                return { valid: false, message: 'Password must contain at least 1 letter.' };
            }
            if (!hasNumber) {
                return { valid: false, message: 'Password must contain at least 1 number.' };
            }
            if (!hasSpecial) {
                return { valid: false, message: 'Password must contain at least 1 special character (!@#$%^&*).' };
            }

            return { valid: true, message: 'Password meets all requirements.' };
        }

        function updatePasswordRequirements(password) {
            const hasMinLength = password.length >= 8;
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

            updateRequirement('req-length', hasMinLength);
            updateRequirement('req-letter', hasLetter);
            updateRequirement('req-number', hasNumber);
            updateRequirement('req-special', hasSpecial);
        }

        function updateRequirement(elementId, isMet) {
            const element = document.getElementById(elementId);
            if (isMet) {
                element.style.color = '#4CAF50';
                element.style.fontWeight = 'bold';
                // Store the original text without the symbol
                const text = element.textContent.replace(/^[‚úó‚úì]\s*/, '');
                element.textContent = '‚úì ' + text;
            } else {
                element.style.color = '#999';
                element.style.fontWeight = 'normal';
                // Store the original text without the symbol
                const text = element.textContent.replace(/^[‚úó‚úì]\s*/, '');
                element.textContent = '‚úó ' + text;
            }
        }

        function checkFormValidity() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = document.getElementById('submitButton');
            const buttonHint = document.getElementById('buttonHint');

            const validation = validatePassword(newPassword);
            const passwordsMatch = newPassword === confirmPassword && confirmPassword.length > 0;

            if (validation.valid && passwordsMatch) {
                submitButton.disabled = false;
                submitButton.style.cursor = 'pointer';
                submitButton.style.opacity = '1';
                buttonHint.textContent = 'Click to reset your password';
                buttonHint.style.color = '#4CAF50';
            } else {
                submitButton.disabled = true;
                submitButton.style.cursor = 'not-allowed';
                submitButton.style.opacity = '0.5';
                if (!validation.valid) {
                    buttonHint.textContent = 'Complete all password requirements';
                } else if (!passwordsMatch) {
                    buttonHint.textContent = 'Passwords must match';
                } else {
                    buttonHint.textContent = 'Complete all requirements to enable button';
                }
                buttonHint.style.color = '#999';
            }
        }

        function setupFormEnhancements() {
            console.log('üîß Setting up form enhancements...');

            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const form = document.getElementById('resetPasswordForm');

            console.log('Form elements found:', {
                newPassword: !!newPasswordInput,
                confirmPassword: !!confirmPasswordInput,
                form: !!form
            });

            // Add focus effects
            [newPasswordInput, confirmPasswordInput].forEach(input => {
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#b22222';
                    this.style.boxShadow = '0 0 0 3px rgba(178, 34, 34, 0.1)';
                });

                input.addEventListener('blur', function() {
                    this.style.borderColor = '#ddd';
                    this.style.boxShadow = 'none';
                });
            });

            // Real-time password requirements validation
            newPasswordInput.addEventListener('input', function() {
                console.log('Password input changed:', this.value.length, 'characters');
                updatePasswordRequirements(this.value);
                checkFormValidity();
            });

            // Real-time password match validation
            confirmPasswordInput.addEventListener('input', function() {
                const newPassword = newPasswordInput.value;
                const confirmPassword = this.value;

                if (confirmPassword.length > 0) {
                    if (newPassword === confirmPassword) {
                        this.style.borderColor = '#4CAF50';
                    } else {
                        this.style.borderColor = '#dc143c';
                    }
                } else {
                    this.style.borderColor = '#ddd';
                }

                checkFormValidity();
            });

            // Form submission
            form.addEventListener('submit', handlePasswordReset);

            // Add button hover effects
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    if (!this.disabled) {
                        this.style.transform = 'translateY(-2px) scale(1.02)';
                    }
                });

                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        }

        // =====================================
        // INITIALIZATION
        // =====================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Password reset page initializing...');

            // Verify the reset token first
            const isValid = await verifyResetToken();

            console.log('Token verification result:', isValid);

            if (isValid) {
                // Set up form enhancements
                console.log('‚úÖ Calling setupFormEnhancements...');
                setupFormEnhancements();
                console.log('‚úÖ setupFormEnhancements completed');
            } else {
                console.error('‚ùå Token verification failed, form enhancements not set up');
            }
        });

        // Add spinning animation for loading state
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Make functions globally accessible
        window.openDieBuddyApp = openDieBuddyApp;

        console.log('‚úÖ Password reset page ready');
    </script>
</body>
</html>
